<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>RTMP Forwarder - 配置与预览</title>
    <style>
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: #ffffff; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #2d2d2d; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 24px; }
        .header p { margin: 5px 0 0 0; color: #ccc; }
        
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .panel { background: #2d2d2d; padding: 20px; border-radius: 8px; }
        .panel h2 { margin-top: 0; font-size: 18px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; color: #ccc; }
        .form-group input, .form-group select { width: 100%; padding: 8px; background: #404040; border: 1px solid #555; border-radius: 4px; color: white; box-sizing: border-box; }
        .form-group input[type="checkbox"] { width: auto; }
        
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn:hover { background: #0056b3; }
        .btn.secondary { background: #6c757d; }
        .btn.secondary:hover { background: #545b62; }
        
        .status { padding: 10px; background: #404040; border-radius: 4px; margin-bottom: 15px; font-size: 14px; }
        .status.success { background: #28a745; color: white; }
        .status.error { background: #dc3545; color: white; }
        .status.warning { background: #ffc107; color: #333; }
        
        .video-container { background: #000; border-radius: 8px; padding: 10px; }
        video { width: 100%; height: auto; background: black; border-radius: 4px; }
        
        .controls { margin-top: 10px; display: flex; gap: 10px; }
        .controls button { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .controls .play-btn { background: #28a745; color: white; }
        .controls .play-btn:hover { background: #218838; }
        .controls .stop-btn { background: #dc3545; color: white; }
        .controls .stop-btn:hover { background: #c82333; }
        .controls .mute-btn { background: #6c757d; color: white; }
        .controls .mute-btn:hover { background: #545b62; }
        
        .log { background: #000; border: 1px solid #444; border-radius: 4px; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .log-line { margin-bottom: 2px; }
        .log-line.info { color: #ccc; }
        .log-line.error { color: #ff6b6b; }
        .log-line.success { color: #51cf66; }
        
        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
        }
    </style>
    <script src="flv.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>RTMP Forwarder</h1>
            <p>配置与预览控制面板</p>
        </div>
        
        <div class="main-content">
            <!-- 配置面板 -->
            <div class="panel">
                <h2>配置设置</h2>
                
                <div id="config-status" class="status">正在加载配置...</div>
                
                <div class="form-group">
                    <label>监听地址</label>
                    <input type="text" id="listen-addr" placeholder="127.0.0.1:1935">
                </div>
                
                <div class="form-group">
                    <label>上游地址</label>
                    <input type="text" id="upstream-addr" placeholder="rtmp://upstream-server:1935/app/stream">
                </div>
                
                <div class="form-group">
                    <label>日志级别</label>
                    <select id="log-level">
                        <option value="info">Info</option>
                        <option value="debug">Debug</option>
                        <option value="warn">Warn</option>
                        <option value="error">Error</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Web 地址</label>
                    <input type="text" id="web-addr" placeholder="0.0.0.0:8080">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="relay-enabled"> 启用中继模式
                    </label>
                </div>
                
                <div class="form-group">
                    <label>中继地址</label>
                    <input type="text" id="relay-addr" placeholder="rtmp://relay-server:1935/app/stream" disabled>
                </div>
                
                <div class="controls" style="margin-top: 0;">
                    <button class="btn" onclick="saveConfig()">保存配置</button>
                    <button class="btn secondary" onclick="loadConfig()">刷新配置</button>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>操作日志</h3>
                    <div id="log" class="log"></div>
                </div>
            </div>
            
            <!-- 预览面板 -->
            <div class="panel">
                <h2>视频预览</h2>
                
                <div id="preview-status" class="status">等待流数据...</div>
                
                <div class="video-container">
                    <video id="video" controls autoplay></video>
                </div>
                
                <div class="controls">
                    <button class="play-btn" onclick="startStream()">开始播放</button>
                    <button class="stop-btn" onclick="stopStream()">停止播放</button>
                    <button class="mute-btn" onclick="toggleMute()">静音/取消静音</button>
                </div>
                
                <div style="margin-top: 15px;">
                    <h3>流信息</h3>
                    <div id="stream-info" class="status">流状态: 未连接</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let player = null;
        let isPlaying = false;
        let logElement = document.getElementById('log');
        
        // 日志函数
        function addLog(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(line);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // 配置相关函数
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                document.getElementById('listen-addr').value = config.listen_addr;
                document.getElementById('upstream-addr').value = config.upstreams[0]?.addr || '';
                document.getElementById('log-level').value = config.log_level;
                document.getElementById('web-addr').value = config.web_addr;
                document.getElementById('relay-enabled').checked = config.relay_enabled;
                document.getElementById('relay-addr').value = config.relay_addr || '';
                document.getElementById('relay-addr').disabled = !config.relay_enabled;
                
                document.getElementById('config-status').className = 'status success';
                document.getElementById('config-status').textContent = '配置加载成功';
                addLog('配置加载成功', 'success');
            } catch (error) {
                document.getElementById('config-status').className = 'status error';
                document.getElementById('config-status').textContent = '配置加载失败: ' + error.message;
                addLog('配置加载失败: ' + error.message, 'error');
            }
        }
        
        async function saveConfig() {
            const config = {
                listen_addr: document.getElementById('listen-addr').value,
                upstreams: [{
                    addr: document.getElementById('upstream-addr').value,
                    app: null,
                    stream: null,
                    enabled: true
                }],
                log_level: document.getElementById('log-level').value,
                web_addr: document.getElementById('web-addr').value,
                relay_enabled: document.getElementById('relay-enabled').checked,
                relay_addr: document.getElementById('relay-addr').value
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const success = await response.json();
                
                if (success) {
                    document.getElementById('config-status').className = 'status success';
                    document.getElementById('config-status').textContent = '配置保存成功';
                    addLog('配置保存成功', 'success');
                } else {
                    document.getElementById('config-status').className = 'status error';
                    document.getElementById('config-status').textContent = '配置保存失败';
                    addLog('配置保存失败', 'error');
                }
            } catch (error) {
                document.getElementById('config-status').className = 'status error';
                document.getElementById('config-status').textContent = '配置保存失败: ' + error.message;
                addLog('配置保存失败: ' + error.message, 'error');
            }
        }
        
        // 预览相关函数
        function updatePreviewStatus(message) {
            document.getElementById('preview-status').textContent = message;
        }
        
        function updateStreamInfo(message) {
            document.getElementById('stream-info').textContent = message;
        }
        
        function startStream() {
            if (isPlaying) {
                updatePreviewStatus('播放器已在运行');
                return;
            }
            
            if (player) {
                player.destroy();
                player = null;
            }
            
            if (!flvjs.isSupported()) {
                updatePreviewStatus('浏览器不支持 FLV 播放');
                addLog('浏览器不支持 FLV 播放', 'error');
                return;
            }
            
            try {
                player = flvjs.createPlayer({
                    type: 'flv',
                    url: '/live/stream.flv'
                });
                
                player.attachMediaElement(document.getElementById('video'));
                player.load();
                
                player.on(flvjs.Events.ERROR, function (errType, errDetail) {
                    updatePreviewStatus('播放错误: ' + errType + ' - ' + errDetail);
                    updateStreamInfo('流状态: 播放错误');
                    addLog('播放错误: ' + errType + ' - ' + errDetail, 'error');
                    console.error('FLV Player Error:', errType, errDetail);
                });
                
                player.on(flvjs.Events.LOADING_COMPLETE, function () {
                    updatePreviewStatus('加载完成');
                    addLog('FLV 流加载完成', 'success');
                });
                
                player.on(flvjs.Events.METADATA_ARRIVED, function () {
                    updatePreviewStatus('元数据已到达，开始播放');
                    updateStreamInfo('流状态: 正在播放');
                    addLog('FLV 流元数据到达', 'success');
                });
                
                player.on(flvjs.Events.RENDERED, function () {
                    updatePreviewStatus('视频已渲染');
                    addLog('FLV 流视频渲染完成', 'success');
                });
                
                player.play();
                isPlaying = true;
                updatePreviewStatus('正在播放 FLV 流');
                updateStreamInfo('流状态: 正在播放');
                addLog('开始播放 FLV 流', 'success');
                
            } catch (error) {
                updatePreviewStatus('播放器初始化失败: ' + error.message);
                updateStreamInfo('流状态: 初始化失败');
                addLog('播放器初始化失败: ' + error.message, 'error');
                console.error('Player Error:', error);
            }
        }
        
        function stopStream() {
            if (player) {
                player.pause();
                player.unload();
                player.detachMediaElement();
                player.destroy();
                player = null;
            }
            isPlaying = false;
            updatePreviewStatus('播放已停止');
            updateStreamInfo('流状态: 已停止');
            addLog('播放已停止', 'info');
        }
        
        function toggleMute() {
            const video = document.getElementById('video');
            video.muted = !video.muted;
            updatePreviewStatus('静音状态已切换: ' + (video.muted ? '已静音' : '未静音'));
            addLog('静音状态切换: ' + (video.muted ? '已静音' : '未静音'), 'info');
        }
        
        // 中继开关事件
        document.getElementById('relay-enabled').addEventListener('change', function() {
            document.getElementById('relay-addr').disabled = !this.checked;
        });
        
        // 页面加载时初始化
        window.onload = function() {
            loadConfig();
            addLog('页面加载完成，准备开始播放', 'info');
            // 自动开始播放
            setTimeout(startStream, 1000);
        };
        
        // 页面关闭时停止播放
        window.onbeforeunload = function() {
            stopStream();
        };
    </script>
</body>
</html>