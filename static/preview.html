<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>RTMP Stream Preview</title>
    <style>
        body { font-family: Arial; background: #222; color: white; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: #333; padding: 20px; margin: 10px 0; border-radius: 8px; }
        #video { width: 100%; height: 400px; background: black; }
        .stream-info { margin: 10px 0; }
        .status { margin: 10px 0; padding: 10px; background: #444; border-radius: 4px; }
        .controls { margin: 10px 0; }
        .controls button { margin-right: 10px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .controls button:hover { background: #0056b3; }
    </style>
    <script src="flv.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>RTMP Stream Preview</h1>
        
        <div class="section">
            <h3>Live Preview</h3>
            <div class="controls">
                <button onclick="startStream()">开始播放</button>
                <button onclick="stopStream()">停止播放</button>
                <button onclick="toggleMute()">静音/取消静音</button>
            </div>
            <div class="stream-info">
                流: <span id="streams">stream</span>
            </div>
            <video id="video" controls muted autoplay></video>
            <div id="status" class="status">状态: 未连接</div>
        </div>
    </div>

    <script>
        let flvPlayer = null;
        let isPlaying = false;
        
        function updateStatus(message) {
            document.getElementById('status').textContent = '状态: ' + message;
        }
        
        function startStream() {
            if (isPlaying) {
                updateStatus('播放器已在运行');
                return;
            }
            
            if (flvPlayer) {
                flvPlayer.destroy();
                flvPlayer = null;
            }
            
            if (flvjs.isSupported()) {
                flvPlayer = flvjs.createPlayer({
                    type: 'flv',
                    url: '/live/stream.flv'
                });
                
                flvPlayer.attachMediaElement(document.getElementById('video'));
                flvPlayer.load();
                
                flvPlayer.on(flvjs.Events.ERROR, function (errType, errDetail) {
                    updateStatus('播放错误: ' + errType + ' - ' + errDetail);
                    console.error('FLV Player Error:', errType, errDetail);
                });
                
                flvPlayer.on(flvjs.Events.LOADING_COMPLETE, function () {
                    updateStatus('加载完成');
                });
                
                flvPlayer.on(flvjs.Events.METADATA_ARRIVED, function () {
                    updateStatus('元数据已到达，开始播放');
                });
                
                flvPlayer.play();
                isPlaying = true;
                updateStatus('正在播放 FLV 流');
            } else {
                updateStatus('浏览器不支持 FLV 播放');
            }
        }
        
        function stopStream() {
            if (flvPlayer) {
                flvPlayer.pause();
                flvPlayer.unload();
                flvPlayer.detachMediaElement();
                flvPlayer.destroy();
                flvPlayer = null;
            }
            isPlaying = false;
            updateStatus('播放已停止');
        }
        
        function toggleMute() {
            const video = document.getElementById('video');
            video.muted = !video.muted;
            updateStatus('静音状态已切换: ' + (video.muted ? '已静音' : '未静音'));
        }
        
        // 页面加载时自动开始播放
        window.onload = function() {
            startStream();
        };
        
        // 页面关闭时停止播放
        window.onbeforeunload = function() {
            stopStream();
        };
    </script>
</body>
</html>
